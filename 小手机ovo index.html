<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>森 - iOS手机 (v2.2 修复版)</title>
    <style>
        :root {
            --phone-width: 375px;
            --phone-height: 750px;
            --primary-text: #000; --secondary-text: #8e8e93;
            --background-color: #f0f2f5; --qq-blue: #12B7F5;
            --battery-green: #34c759; --battery-red: #ff3b30;
        }

        body { display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #333; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; }
        .phone-container { width: var(--phone-width); height: var(--phone-height); background: #fff; border-radius: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: flex; flex-direction: column; overflow: hidden; position: relative; border: 8px solid #111; }
        .screen { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; background-color: var(--background-color); }

        /* 状态栏样式 */
        .status-bar { height: 40px; display: flex; justify-content: space-between; align-items: center; padding: 0 12px; color: var(--primary-text); font-size: 16px; font-weight: 600; position: absolute; top: 0; left: 0; right: 0; z-index: 1100; background-color: transparent; }
        .left-items, .right-items { display: flex; align-items: center; height: 100%; }
        .left-items { cursor: pointer; }
        .right-items { gap: 8px; cursor: pointer; }
        .time { font-weight: 700; }
        .dnd-icon { margin-left: 12px; font-size: 20px; display: none; }
        .network-container { display: flex; align-items: center; margin-right: 8px; }
        .network-type { margin-right: 8px; font-size: 14px; }
        .signal-bars { display: flex; align-items: flex-end; height: 14px; }
        .signal-bar { width: 4px; background-color: currentColor; margin-right: 1px; border-radius: 1px; }
        .signal-bar:nth-child(1) { height: 5px; } .signal-bar:nth-child(2) { height: 7px; } .signal-bar:nth-child(3) { height: 9px; } .signal-bar:nth-child(4) { height: 11px; } .signal-bar:nth-child(5) { height: 14px; margin-right: 0; }
        .battery-container { display: flex; align-items: center; }
        .battery-icon { width: 32px; height: 16px; border: 2px solid currentColor; border-radius: 5px; position: relative; overflow: hidden; }
        .battery-icon::after { content: ''; position: absolute; right: -4px; top: 4px; width: 3px; height: 8px; background-color: currentColor; border-radius: 0 3px 3px 0; }
        .battery-level { position: absolute; top: 1px; left: 1px; bottom: 1px; background-color: currentColor; border-radius: 3px; width: 80%; transition: width 0.5s ease, background-color 0.5s ease; }
        .battery-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: bold; color: #111; z-index: 2; }
        .charging .battery-level { background-color: var(--battery-green); }
        .low-battery .battery-level { background-color: var(--battery-red); }

        /* 灵动岛样式 */
        .dynamic-island { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 140px; height: 40px; background-color: rgba(0, 0, 0, 0.8); border-radius: 25px; display: flex; justify-content: center; align-items: center; color: white; font-size: 16px; cursor: pointer; transition: all 0.3s ease; z-index: 1099; }
        .dynamic-island.expanded { width: 320px; height: 90px; border-radius: 45px; flex-direction: column; }
        .island-content { display: flex; align-items: center; }
        .island-icon { margin-right: 10px; font-size: 18px; }
        .expanded-content { display: none; text-align: center; margin-top: 8px; font-size: 14px; }
        .expanded .expanded-content { display: block; }
        .music-controls { display: none; flex-direction: column; align-items: center; width: 100%; padding: 10px; box-sizing: border-box; }
        .music-info { font-size: 14px; margin-bottom: 8px; }
        .music-progress { width: 90%; height: 4px; background-color: rgba(255,255,255,0.3); border-radius: 3px; margin-bottom: 8px; }
        .music-progress-bar { height: 100%; width: 50%; background-color: white; border-radius: 3px; }
        .music-buttons { display: flex; justify-content: center; align-items: center; }
        .music-btn { margin: 0 8px; font-size: 18px; cursor: pointer; }

        /* 主屏幕 & Dock */
        .home-screen { flex: 1; padding-top: 40px; padding-bottom: 100px; overflow-y: auto; display: grid; grid-template-columns: repeat(4, 1fr); grid-auto-rows: min-content; gap: 20px; padding: 60px 20px 100px; }
        .app-icon { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .app-icon-image { width: 60px; height: 60px; border-radius: 15px; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; overflow: hidden; background-color: white; padding: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .app-icon-image img { width: 100%; height: 100%; object-fit: cover; border-radius: 11px; }
        .app-icon-name { font-size: 12px; color: var(--primary-text); text-align: center; }
        .dock { position: absolute; bottom: 0; left: 0; right: 0; height: 100px; background-color: rgba(240, 242, 245, 0.8); backdrop-filter: blur(12px); display: flex; justify-content: center; align-items: center; padding: 0 25px; }
        .dock-apps { display: flex; justify-content: space-around; width: 100%; }
        .dock-app { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .dock-app-icon { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; background-color: white; padding: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .dock-app-icon img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }

        /* 底部导航栏 */
        .home-indicator { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 120px; height: 5px; background-color: #000; border-radius: 3px; cursor: pointer; z-index: 1100; }
        
        /* 控制中心和通知中心 */
        .control-center, .notification-center { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(240,240,240,0.95); backdrop-filter: blur(25px); z-index: 1200; padding: 25px; display: none; flex-direction: column; overflow-y: auto; }
        .notification-center { background-color: rgba(250,250,250,0.95); }
        .cc-header, .nc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .cc-title, .nc-title { font-weight: bold; font-size: 22px; }
        .cc-close, .nc-close { font-size: 28px; cursor: pointer; }
        .cc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .cc-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .cc-icon { width: 60px; height: 60px; border-radius: 15px; background-color: rgba(200,200,200,0.5); display: flex; align-items: center; justify-content: center; font-size: 28px; margin-bottom: 8px; overflow: hidden; }
        .cc-icon img { width: 100%; height: 100%; object-fit: contain; padding: 10px; box-sizing: border-box; }
        .cc-name { font-size: 14px; text-align: center; }
        .brightness-slider { width: 100%; height: 35px; margin: 20px 0; }
        .brightness-control { width: 100%; }
        .media-player { width: 100%; background-color: rgba(200,200,200,0.5); border-radius: 15px; padding: 15px; margin-bottom: 20px; }
        .media-info { display: flex; align-items: center; margin-bottom: 15px; }
        .media-cover { width: 60px; height: 60px; border-radius: 8px; background-color: #ccc; margin-right: 15px; }
        .media-text { flex: 1; }
        .media-title { font-weight: bold; font-size: 18px; }
        .media-artist { font-size: 14px; color: var(--secondary-text); }
        .media-controls { display: flex; justify-content: space-between; align-items: center; }
        .media-btn { font-size: 28px; cursor: pointer; }
        .media-progress { width: 100%; height: 4px; background-color: rgba(0,0,0,0.1); border-radius: 3px; margin: 8px 0; }
        .media-progress-bar { height: 100%; width: 50%; background-color: #007AFF; border-radius: 3px; }
        .media-time { display: flex; justify-content: space-between; font-size: 14px; color: var(--secondary-text); }
        .notification-item { background-color: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
        .notification-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .notification-app { font-weight: bold; font-size: 16px; }
        .notification-time { font-size: 14px; color: var(--secondary-text); }
        .notification-content { font-size: 16px; }

        /* 应用容器与页面 */
        .app-container, .app-page { position: absolute; inset: 0; background-color: #f5f5f5; display: none; flex-direction: column; z-index: 1000; transform: translateX(100%); transition: transform 0.3s ease-in-out; }
        .app-container.active, .app-page.active { display: flex; transform: translateX(0); }
        .app-header { height: 50px; display: flex; align-items: center; padding: 0 15px; color: var(--primary-text); position: relative; background-color: #f7f7f7; border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .app-back-btn { font-size: 22px; cursor: pointer; padding: 5px 10px; margin-left: -10px; }
        .app-title { flex: 1; text-align: center; font-weight: bold; font-size: 18px; position: absolute; left: 50%; transform: translateX(-50%); }
        .app-content { flex: 1; padding: 20px; overflow-y: auto; }

        /* 设置菜单样式 */
        .settings-menu { display: flex; flex-direction: column; gap: 10px; }
        .setting-item { background-color: white; padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 16px; }
        .setting-item:hover { background-color: #f0f0f0; }
        .setting-item::after { content: '>'; color: #ccc; }

        /* API 设置样式 */
        .api-settings { display: flex; flex-direction: column; gap: 15px; }
        .api-settings h2 { margin: 0 0 10px 0; font-size: 22px; }
        .api-form-group { display: flex; flex-direction: column; }
        .api-form-group label { margin-bottom: 5px; font-size: 14px; color: #555; }
        .api-form-group select, .api-form-group input { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        .api-actions { display: flex; gap: 10px; margin-top: 10px; }
        .api-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.2s; }
        .api-btn-primary { background-color: var(--qq-blue); color: white; }
        .api-btn-secondary { background-color: #e0e0e0; color: #333; }
        .api-status { margin-top: 15px; padding: 10px; border-radius: 8px; text-align: center; }
        .api-status.success { background-color: #d4edda; color: #155724; }
        .api-status.error { background-color: #f8d7da; color: #721c24; }
        .api-models-list { margin-top: 20px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; max-height: 200px; overflow-y: auto; }
        .api-models-list h3 { margin: 0 0 10px 0; }
        .api-model-item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s; }
        .api-model-item:hover { background-color: #f5f5f5; }
        .api-model-item.selected { background-color: #e6f7ff; border-left: 3px solid var(--qq-blue); }
        .api-model-item:last-child { border-bottom: none; }
        .api-model-name { font-weight: bold; }
        .api-model-id { font-size: 12px; color: #777; }
        .current-model { margin-top: 15px; padding: 10px; background-color: #f0f8ff; border-radius: 8px; border: 1px solid #d0e8ff; }
        .current-model h4 { margin: 0 0 5px 0; font-size: 16px; }
        .current-model p { margin: 0; font-size: 14px; color: #555; }

        /* 世界书菜单样式 */
        .worldbook-menu { display: flex; flex-direction: column; gap: 20px; margin-bottom: 20px; }
        .menu-section { background-color: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .menu-section h2 { margin: 0 0 15px 0; font-size: 18px; color: #333; }
        .menu-item { display: flex; align-items: center; padding: 12px 10px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .menu-item:hover { background-color: #f5f5f5; }
        .menu-icon { font-size: 24px; margin-right: 12px; width: 30px; text-align: center; }
        .menu-text { font-size: 16px; color: #333; }
        .worldbook-content { display: none; background-color: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* 数据管理样式 */
        .data-management { display: flex; flex-direction: column; gap: 15px; }
        .data-actions { display: flex; flex-direction: column; gap: 10px; }
        .data-btn { padding: 12px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.2s; }
        .data-btn-primary { background-color: var(--qq-blue); color: white; }
        .data-btn-secondary { background-color: #e0e0e0; color: #333; }
        .file-input { display: none; }

        /* 暗色模式 */
        @media (prefers-color-scheme: dark) {
            :root { --primary-text: #fff; --secondary-text: #8e8e93; --background-color: #000; }
            .phone-container { background: #1c1c1e; }
            .screen { background-color: #000; }
            .app-icon-name { color: white; }
            .dock { background-color: rgba(28, 28, 30, 0.8); }
            .home-indicator { background-color: #fff; }
            .app-container, .app-page, .app-header { background-color: #1c1c1e; color: #fff; border-bottom-color: #38383a; }
            .api-form-group label { color: #aaa; }
            .api-form-group select, .api-form-group input { background-color: #333; color: #fff; border-color: #555; }
            .setting-item { background-color: #2c2c2e; }
            .setting-item:hover { background-color: #3a3a3c; }
        }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="screen">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div class="left-items" onclick="showNotificationCenter()">
                    <div class="time">上午9:41</div>
                    <div class="dnd-icon">🌙</div>
                </div>
                <div class="right-items" onclick="showControlCenter()">
                    <div class="network-container">
                        <div class="network-type">5G</div>
                        <div class="signal-bars"><div class="signal-bar"></div><div class="signal-bar"></div><div class="signal-bar"></div><div class="signal-bar"></div><div class="signal-bar"></div></div>
                    </div>
                    <div class="battery-container">
                        <div class="battery-icon"><div class="battery-level"></div><div class="battery-text">80</div></div>
                    </div>
                </div>
            </div>
            
            <!-- 灵动岛 -->
            <div class="dynamic-island" onclick="this.classList.toggle('expanded')">
                <div class="island-content"><div class="island-icon">ㅇㅅㅇ</div><div>森</div></div>
                <div class="expanded-content"><div>欢迎使用森</div><div>点击应用开始使用</div></div>
                <div class="music-controls">
                    <div class="music-info">正在播放: 歌曲名称</div>
                    <div class="music-progress"><div class="music-progress-bar"></div></div>
                    <div class="music-buttons"><div class="music-btn">⊲</div><div class="music-btn">⋄</div><div class="music-btn">⊳</div></div>
                </div>
            </div>

            <!-- 主屏幕 -->
            <div class="home-screen"></div>

            <!-- 底部导航栏 -->
            <div class="dock"><div class="dock-apps"></div></div>
            
            <!-- Home指示器 -->
            <div class="home-indicator" onclick="returnToHome()"></div>
        
            <!-- 控制中心 -->
            <div class="control-center">
                <div class="cc-header"><div class="cc-title">控制中心</div><div class="cc-close" onclick="hideControlCenter()">×</div></div>
                <div class="cc-grid">
                    <div class="cc-item" onclick="toggleWifi()"><div class="cc-icon"><img src="https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251025/DWyy/1015X861/Image_1761364260122.png" alt="WiFi"></div><div class="cc-name">无线局域网</div></div>
                    <div class="cc-item" onclick="toggleBluetooth()"><div class="cc-icon"><img src="https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251025/7NYe/1208X1072/Image_1761364261254.png" alt="Bluetooth"></div><div class="cc-name">蓝牙</div></div>
                    <div class="cc-item" onclick="toggleAirplaneMode()"><div class="cc-icon"><img src="https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251025/wdgd/643X630/Image_1761364259392.png" alt="Airplane Mode"></div><div class="cc-name">飞行模式</div></div>
                    <div class="cc-item" onclick="toggleCellular()"><div class="cc-icon"><img src="https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251025/YOpv/1186X1080/Image_1761364260618.png" alt="Cellular"></div><div class="cc-name">蜂窝网络</div></div>
                    <div class="cc-item" onclick="toggleHotspot()"><div class="cc-icon"><img src="https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251025/h86b/640X594/Image_1761364260149.png" alt="Hotspot"></div><div class="cc-name">个人热点</div></div>
                    <div class="cc-item" onclick="toggleDND()"><div class="cc-icon"><img src="https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251025/qu4r/527X693/Image_1761364259317.png" alt="DND"></div><div class="cc-name">勿扰模式</div></div>
                    <div class="cc-item" onclick="toggleOrientationLock()"><div class="cc-icon"><img src="https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251025/ve2L/1646X1005/Image_1761364258979.png" alt="Orientation Lock"></div><div class="cc-name">方向锁定</div></div>
                    <div class="cc-item" onclick="openFlashlight()"><div class="cc-icon"><img src="https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251025/144c/1208X758/Image_1761364260710.png" alt="Flashlight"></div><div class="cc-name">手电筒</div></div>
                </div>
                <div class="brightness-slider"><input type="range" min="0" max="100" value="50" class="brightness-control"></div>
                <div class="media-player">
                    <div class="media-info"><div class="media-cover"></div><div class="media-text"><div class="media-title">歌曲名称</div><div class="media-artist">艺术家</div></div></div>
                    <div class="media-controls"><div class="media-btn">⊲</div><div class="media-btn">⋄</div><div class="media-btn">⊳</div></div>
                    <div class="media-progress"><div class="media-progress-bar"></div></div>
                    <div class="media-time"><div>1:23</div><div>3:45</div></div>
                </div>
            </div>

            <!-- 通知中心 -->
            <div class="notification-center">
                <div class="nc-header"><div class="nc-title">通知</div><div class="nc-close" onclick="hideNotificationCenter()">×</div></div>
                <div class="notification-item"><div class="notification-header"><div class="notification-app">信息</div><div class="notification-time">刚刚</div></div><div class="notification-content">您收到一条新消息</div></div>
                <div class="notification-item"><div class="notification-header"><div class="notification-app">QQ</div><div class="notification-time">10分钟前</div></div><div class="notification-content">好友发来一条消息</div></div>
            </div>

            <!-- 应用容器 -->
            <div class="app-container" id="messageContainer"><div class="app-header"><div class="app-back-btn" onclick="closeApp('messageContainer')">←</div><div class="app-title">信息</div></div><div class="app-content"></div></div>
            <div class="app-container" id="forumContainer"><div class="app-header"><div class="app-back-btn" onclick="closeApp('forumContainer')">←</div><div class="app-title">论坛八卦</div></div><div class="app-content"></div></div>
            
            <!-- 设置应用 -->
            <div class="app-container" id="settingsContainer">
                <div class="app-header"><div class="app-back-btn" onclick="closeApp('settingsContainer')">←</div><div class="app-title">设置</div></div>
                <div class="app-content">
                    <div class="settings-menu">
                        <div class="setting-item" onclick="openAppPage('apiSettingsPage')">API与模型设置</div>
                        <div class="setting-item" onclick="openAppPage('dataManagementPage')">数据管理</div>
                        <div class="setting-item">通用</div>
                        <div class="setting-item">显示与亮度</div>
                        <div class="setting-item">墙纸</div>
                    </div>
                </div>
            </div>
            
            <!-- API设置页面 -->
            <div class="app-page" id="apiSettingsPage">
                <div class="app-header"><div class="app-back-btn" onclick="closeAppPage('apiSettingsPage')">←</div><div class="app-title">API设置</div></div>
                <div class="app-content">
                    <div class="api-settings">
                        <div class="current-model" id="currentModelDisplay" style="display: none;"><h4>当前选定模型</h4><p id="currentModelName">无</p></div>
                        <div class="api-form-group"><label for="apiProvider">API接口模型供应商</label><select id="apiProvider"><option value="openai">OpenAI</option><option value="anthropic">Anthropic</option><option value="google">Google Gemini</option><option value="custom">自定义</option></select></div>
                        <div class="api-form-group"><label for="apiUrl">填写URL链接</label><input type="url" id="apiUrl" placeholder="https://api.openai.com"></div>
                        <div class="api-form-group"><label for="apiKey">输入API密钥</label><input type="password" id="apiKey" placeholder="输入您的API密钥"></div>
                        <div class="api-actions"><button class="api-btn api-btn-primary" onclick="fetchModels()">获取模型</button><button class="api-btn api-btn-secondary" onclick="testApiConnection()">测试模型</button></div>
                        <div class="api-status" id="apiStatus"></div>
                        <div class="api-models-list" id="apiModelsList" style="display: none;"></div>
                        <div class="api-actions" style="margin-top: 20px;"><button class="api-btn api-btn-primary" onclick="saveApiSettings()">保存设置</button></div>
                    </div>
                </div>
            </div>

            <!-- 数据管理页面 -->
            <div class="app-page" id="dataManagementPage">
                <div class="app-header"><div class="app-back-btn" onclick="closeAppPage('dataManagementPage')">←</div><div class="app-title">数据管理</div></div>
                <div class="app-content">
                    <div class="data-management">
                        <h2>数据备份与恢复</h2>
                        <div class="data-actions">
                            <button class="data-btn data-btn-primary" onclick="exportAllData()">导出全部数据</button>
                            <button class="data-btn data-btn-secondary" onclick="document.getElementById('importFile').click()">导入数据</button>
                            <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(this)">
                        </div>
                    </div>
                </div>
            </div>

            <div class="app-container" id="phoneContainer"><div class="app-header"><div class="app-back-btn" onclick="closeApp('phoneContainer')">←</div><div class="app-title">电话</div></div><div class="app-content"></div></div>
            <div class="app-container" id="photosContainer"><div class="app-header"><div class="app-back-btn" onclick="closeApp('photosContainer')">←</div><div class="app-title">备忘录</div></div><div class="app-content"></div></div>
            
            <!-- 世界书应用 -->
            <div class="app-container" id="booksContainer">
                <div class="app-header"><div class="app-back-btn" onclick="closeApp('booksContainer')">←</div><div class="app-title">世界书</div></div>
                <div class="app-content">
                    <div class="worldbook-menu">
                        <div class="menu-section"><h2>世界书管理</h2><div class="menu-item" onclick="openWorldbookTab('create')"><div class="menu-icon">📖</div><div class="menu-text">创建新世界书</div></div><div class="menu-item" onclick="openWorldbookTab('library')"><div class="menu-icon">📚</div><div class="menu-text">世界书库</div></div><div class="menu-item" onclick="openWorldbookTab('import')"><div class="menu-icon">⬇️</div><div class="menu-text">导入世界书</div></div><div class="menu-item" onclick="openWorldbookTab('export')"><div class="menu-icon">⬆️</div><div class="menu-text">导出世界书</div></div></div>
                        <div class="menu-section"><h2>编辑工具</h2><div class="menu-item" onclick="openWorldbookTab('characters')"><div class="menu-icon">👥</div><div class="menu-text">角色管理</div></div><div class="menu-item" onclick="openWorldbookTab('locations')"><div class="menu-icon">🗺️</div><div class="menu-text">地点管理</div></div><div class="menu-item" onclick="openWorldbookTab('timeline')"><div class="menu-icon">⏳</div><div class="menu-text">时间线</div></div><div class="menu-item" onclick="openWorldbookTab('relations')"><div class="menu-icon">🔗</div><div class="menu-text">关系图</div></div></div>
                        <div class="menu-section"><h2>设置</h2><div class="menu-item" onclick="openWorldbookTab('settings')"><div class="menu-icon">⚙️</div><div class="menu-text">世界书设置</div></div><div class="menu-item" onclick="openWorldbookTab('templates')"><div class="menu-icon">📝</div><div class="menu-text">模板管理</div></div></div>
                    </div>
                    <div class="worldbook-content" id="worldbookContent"></div>
                </div>
            </div>

            <div class="app-container" id="qqContainer"><div class="app-header"><div class="app-back-btn" onclick="closeApp('qqContainer')">←</div><div class="app-title">QQ</div></div><div class="app-content"></div></div>
            <div class="app-container" id="musicContainer"><div class="app-header"><div class="app-back-btn" onclick="closeApp('musicContainer')">←</div><div class="app-title">音乐</div></div><div class="app-content"></div></div>
            <div class="app-container" id="themeContainer"><div class="app-header"><div class="app-back-btn" onclick="closeApp('themeContainer')">←</div><div class="app-title">美化</div></div><div class="app-content"></div></div>
            <div class="app-container" id="jdContainer"><div class="app-header"><div class="app-back-btn" onclick="closeApp('jdContainer')">←</div><div class="app-title">网购</div></div><div class="app-content"></div></div>
            <div class="app-container" id="meituanContainer"><div class="app-header"><div class="app-back-btn" onclick="closeApp('meituanContainer')">←</div><div class="app-title">外卖</div></div><div class="app-content"></div></div>
        </div>
    </div>
    
    <script>
        // --- 全局状态管理 ---
        let systemData = {};
        const defaultSystemData = {
            battery: { level: 80, isCharging: false },
            network: { wifi: true, cellular: true, airplaneMode: false },
            settings: { 
                dnd: false,
                apiProvider: 'openai', 
                apiKey: '', 
                apiUrl: '',
                selectedModel: null
            },
            worldbooks: {
                library: [],
                current: null
            }
        };

        // --- 系统UI与交互 ---
        function updateTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? '下午' : '上午';
            const displayHours = hours % 12 || 12;
            document.querySelector('.time').textContent = `${ampm}${displayHours}:${minutes}`;
        }

        function updateBattery() {
            const batteryIcon = document.querySelector('.battery-icon');
            const batteryLevelEl = document.querySelector('.battery-level');
            const batteryText = document.querySelector('.battery-text');
            if (!systemData.battery.isCharging && systemData.battery.level > 0.1) systemData.battery.level -= 0.1;
            batteryLevelEl.style.width = `${systemData.battery.level}%`;
            batteryText.textContent = Math.round(systemData.battery.level);
            batteryIcon.classList.toggle('charging', systemData.battery.isCharging);
            batteryIcon.classList.toggle('low-battery', !systemData.battery.isCharging && systemData.battery.level <= 20);
        }

        function showControlCenter() { document.querySelector('.control-center').style.display = 'flex'; }
        function hideControlCenter() { document.querySelector('.control-center').style.display = 'none'; }
        function showNotificationCenter() { document.querySelector('.notification-center').style.display = 'flex'; }
        function hideNotificationCenter() { document.querySelector('.notification-center').style.display = 'none'; }

        function toggleWifi() { alert('无线局域网功能已切换'); }
        function toggleBluetooth() { alert('蓝牙功能已切换'); }
        function toggleAirplaneMode() { alert('飞行模式功能已切换'); }
        function toggleCellular() { alert('蜂窝网络功能已切换'); }
        function toggleHotspot() { alert('个人热点功能已切换'); }
        function toggleDND() { systemData.settings.dnd = !systemData.settings.dnd; document.querySelector('.dnd-icon').style.display = systemData.settings.dnd ? 'block' : 'none'; alert(`勿扰模式已${systemData.settings.dnd ? '开启' : '关闭'}`); }
        function toggleOrientationLock() { alert('方向锁定功能已切换'); }
        function openFlashlight() { alert('手电筒功能已切换'); }

        // --- 应用导航 ---
        function openApp(appId) { const app = document.getElementById(appId); if(app) app.classList.add('active'); }
        function closeApp(appId) { const app = document.getElementById(appId); if(app) app.classList.remove('active'); }
        function openAppPage(pageId) { const page = document.getElementById(pageId); if(page) page.classList.add('active'); }
        function closeAppPage(pageId) { const page = document.getElementById(pageId); if(page) page.classList.remove('active'); }
        function returnToHome() { document.querySelectorAll('.app-container.active, .app-page.active').forEach(el => el.classList.remove('active')); }

        // --- API 核心功能 ---
        async function fetchModels() {
            const provider = document.getElementById('apiProvider').value;
            let apiUrl = document.getElementById('apiUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const statusEl = document.getElementById('apiStatus');
            const modelsListEl = document.getElementById('apiModelsList');
            
            modelsListEl.style.display = 'none';
            modelsListEl.innerHTML = '';
            if (!apiUrl || !apiKey) {
                statusEl.textContent = '错误：请填写完整的API URL和密钥。';
                statusEl.className = 'api-status error';
                return;
            }
            
            statusEl.textContent = '正在获取模型列表...';
            statusEl.className = 'api-status';

            if (apiUrl.endsWith('/')) apiUrl = apiUrl.slice(0, -1);
            if (provider === 'openai' && !apiUrl.endsWith('/v1')) apiUrl += '/v1';

            let requestUrl = `${apiUrl}/models`;
            let headers = { 'Content-Type': 'application/json' };

            if (provider === 'openai' || provider === 'custom') headers['Authorization'] = `Bearer ${apiKey}`;
            else if (provider === 'anthropic') { headers['x-api-key'] = apiKey; headers['anthropic-version'] = '2023-06-01'; }
            else if (provider === 'google') { requestUrl = `${apiUrl}/v1beta/models?key=${apiKey}`; headers = {}; }

            try {
                const response = await fetch(requestUrl, { headers });
                if (!response.ok) { const errorData = await response.text(); throw new Error(`请求失败 (${response.status}): ${errorData}`); }
                const data = await response.json();
                
                let models = data.data || data.models || [];
                if (models.length > 0) {
                    modelsListEl.innerHTML = '<h3>可用模型列表 (点击选择)</h3>';
                    models.forEach(model => {
                        const modelId = model.id || model.name;
                        const modelName = model.id || model.name || model.displayName;
                        const modelEl = document.createElement('div');
                        modelEl.className = 'api-model-item';
                        modelEl.innerHTML = `<div class="api-model-name">${modelName.split('/').pop()}</div><div class="api-model-id">ID: ${modelId}</div>`;
                        
                        modelEl.addEventListener('click', () => {
                            document.querySelectorAll('.api-model-item.selected').forEach(item => item.classList.remove('selected'));
                            modelEl.classList.add('selected');
                            systemData.settings.selectedModel = { id: modelId, name: modelName };
                            updateCurrentModelDisplay();
                        });
                        
                        modelsListEl.appendChild(modelEl);
                    });
                    modelsListEl.style.display = 'block';
                    statusEl.textContent = `成功获取 ${models.length} 个模型，请点击选择一个模型`;
                    statusEl.className = 'api-status success';
                } else {
                    statusEl.textContent = '警告：API成功响应，但未找到可用模型。';
                    statusEl.className = 'api-status error';
                }
            } catch (error) {
                statusEl.textContent = `获取模型失败: ${error.message}`;
                statusEl.className = 'api-status error';
                console.error('获取模型失败详情:', error);
            }
        }

        function updateCurrentModelDisplay() {
            const display = document.getElementById('currentModelDisplay');
            const nameEl = document.getElementById('currentModelName');
            if (systemData.settings.selectedModel) {
                nameEl.textContent = systemData.settings.selectedModel.name;
                display.style.display = 'block';
            } else {
                display.style.display = 'none';
            }
        }

        async function testApiConnection() {
            const statusEl = document.getElementById('apiStatus');
            statusEl.textContent = '正在测试连接...';
            statusEl.className = 'api-status';
            await fetchModels();
            if (statusEl.classList.contains('success')) statusEl.textContent = 'API连接测试成功！';
        }

        function saveApiSettings() {
            systemData.settings.apiProvider = document.getElementById('apiProvider').value;
            systemData.settings.apiUrl = document.getElementById('apiUrl').value.trim();
            systemData.settings.apiKey = document.getElementById('apiKey').value.trim();
            const statusEl = document.getElementById('apiStatus');
            statusEl.textContent = systemData.settings.selectedModel ? `API设置已保存，已选择模型: ${systemData.settings.selectedModel.name}` : 'API设置已保存，但未选择模型。';
            statusEl.className = 'api-status success';
            updateCurrentModelDisplay();
            saveSystemData();
        }

        // --- 世界书功能 ---
        function openWorldbookTab(tabName) {
            const contentEl = document.getElementById('worldbookContent');
            contentEl.style.display = 'block';
            let html = `<h3>${tabName}</h3><p>此功能正在开发中...</p>`;
            if (tabName === 'library') {
                html = '<h3>世界书库</h3><div id="worldbookList"></div>';
                contentEl.innerHTML = html;
                loadWorldbookLibrary();
            } else {
                contentEl.innerHTML = html;
            }
        }
        function loadWorldbookLibrary() { document.getElementById('worldbookList').innerHTML = systemData.worldbooks.library.length === 0 ? '<p>暂无世界书</p>' : systemData.worldbooks.library.map(wb => `<div>${wb.name}</div>`).join(''); }

        // --- 数据管理 ---
        function exportAllData() {
            const dataStr = JSON.stringify(systemData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileName = `森手机数据备份_${new Date().toISOString().slice(0, 10)}.json`;
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileName);
            linkElement.click();
            showAlert('数据导出成功！');
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (!imported.settings || !imported.worldbooks) throw new Error('导入的文件格式不正确');
                    if (confirm('确定要导入数据吗？这将覆盖当前所有设置。')) {
                        systemData = imported;
                        updateUIFromSystemData();
                        saveSystemData();
                        showAlert('数据导入成功！');
                    }
                } catch (error) { showAlert(`导入失败: ${error.message}`); }
                input.value = '';
            };
            reader.readAsText(file);
        }

        function updateUIFromSystemData() {
            document.getElementById('apiProvider').value = systemData.settings.apiProvider;
            document.getElementById('apiUrl').value = systemData.settings.apiUrl;
            document.getElementById('apiKey').value = systemData.settings.apiKey;
            updateCurrentModelDisplay();
        }

        function showAlert(message) {
            const statusEl = document.getElementById('apiStatus');
            statusEl.textContent = message;
            statusEl.className = 'api-status success';
            setTimeout(() => { if (statusEl.textContent === message) { statusEl.textContent = ''; statusEl.className = 'api-status'; } }, 3000);
        }

        // --- 本地存储 ---
        function saveSystemData() { try { localStorage.setItem('moriPhoneData', JSON.stringify(systemData)); } catch (e) { console.error('无法保存到本地存储:', e); } }
        function loadSystemData() { try { const saved = localStorage.getItem('moriPhoneData'); systemData = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultSystemData)); } catch (e) { systemData = JSON.parse(JSON.stringify(defaultSystemData)); } }

        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            const appData = [
                { id: 'messageContainer', icon: 'https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251025/YOpv/1186X1080/Image_1761364260618.png', name: '信息' },
                { id: 'forumContainer', icon: 'https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251021/KpZf/1079X1083/Image_1760785735649.png', name: '论坛八卦' },
                { id: 'settingsContainer', icon: 'https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251025/DWyy/1015X861/Image_1761364260122.png', name: '设置' },
                { id: 'phoneContainer', icon: 'https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251025/7NYe/1208X1072/Image_1761364261254.png', name: '电话' },
                { id: 'photosContainer', icon: 'https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251025/OJ0P/920X1024/Image_1760785734981.png', name: '备忘录' },
                { id: 'booksContainer', icon: 'https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251021/yD6d/742X1024/Image_1760785734886.png', name: '世界书' },
                { id: 'qqContainer', icon: 'https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251025/qu4r/527X693/Image_1761364259317.png', name: 'QQ' },
                { id: 'musicContainer', icon: 'https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251025/C1S1/863X793/Image_1761364257242.png', name: '音乐' },
                { id: 'themeContainer', icon: 'https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251025/wdgd/643X630/Image_1761364259392.png', name: '美化' },
                { id: 'jdContainer', icon: 'https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251025/h86b/640X594/Image_1761364260149.png', name: '网购' },
                { id: 'meituanContainer', icon: 'https://tc.z.wiki/autoupload/f/_dUEGnKEJQzmc-cKlsXN5NiO_OyvX7mIgxFBfDMDErs/20251025/L6Oz/985X1112/Image_1761364257742.png', name: '外卖' },
            ];
            
            const homeScreen = document.querySelector('.home-screen');
            const dockApps = document.querySelector('.dock-apps');
            const dockAppIds = ['phoneContainer', 'messageContainer', 'photosContainer', 'settingsContainer'];

            appData.forEach(app => {
                const isDockApp = dockAppIds.includes(app.id);
                const container = isDockApp ? dockApps : homeScreen;
                const el = document.createElement('div');
                el.className = isDockApp ? 'dock-app' : 'app-icon';
                el.onclick = () => openApp(app.id);
                el.innerHTML = `<div class="${isDockApp ? 'dock-app-icon' : 'app-icon-image'}"><img src="${app.icon}" alt="${app.name}"></div>${!isDockApp ? `<div class="app-icon-name">${app.name}</div>` : ''}`;
                container.appendChild(el);
            });

            loadSystemData();
            updateUIFromSystemData();
            updateTime();
            updateBattery();
            setInterval(updateTime, 1000);
            setInterval(updateBattery, 5000);
        });
    </script>
</body>
</html>
